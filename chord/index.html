<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»£p Ã‚m Piano</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%; margin: 0 auto;
            background: white; border-radius: 15px;
            padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; color: #333; margin-bottom: 15px; font-size: 24px; }
        .chord-selector { margin-bottom: 20px; }
        .selector-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        select {
            flex: 1; min-width: 120px; padding: 10px; font-size: 16px;
            border: 2px solid #667eea; border-radius: 8px; background: white; cursor: pointer;
        }
        .play-buttons { display: flex; gap: 10px; margin-bottom: 20px;}
        button {
            flex: 1; padding: 12px; font-size: 16px; font-weight: bold; border: none;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .play-sequential { background: #4CAF50; color: white; }
        .play-together { background: #2196F3; color: white; }
        button:active { transform: scale(0.95);}
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .audio-activate-wrapper {
            text-align:center;
            margin-bottom: 12px;
        }
        #audioActivateBtn {
            background: #ffd700;
            color:#333;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 14px;
            border: none;
            cursor:pointer;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        #audioActivateBtn:disabled {
            opacity:.7;
            cursor:not-allowed;
        }
        .piano {
            position: relative; display: flex; justify-content: flex-start;
            margin: 20px auto; height: 180px; overflow-x: auto; overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .piano-keys { 
            position: relative; 
            display: inline-flex; 
            white-space: nowrap; 
            min-width: min-content; 
            height: 180px;
            align-items: flex-start;
        }
        .key { position: relative; cursor: pointer; user-select: none; flex-shrink: 0; }
        .white-key {
            width: 28px; height: 180px; background: white; border: 1px solid #000;
            border-radius: 0 0 4px 4px; transition: all 0.1s; position: relative;
        }
        .white-key:active { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .white-key.highlight { background: #ffeb3b; box-shadow: 0 0 10px rgba(255,235,59,0.8);}
        .white-key.playing { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .black-key {
            width: 20px; height: 110px; background: #000; border: 1px solid #000;
            border-radius: 0 0 3px 3px; position: absolute; z-index: 10;
            top: 0;
        }
        .black-key:active { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .black-key.highlight { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.8);}
        .black-key.playing { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .key-label {
            position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            font-size: 10px; font-weight: bold; pointer-events: none;
        }
        .white-key .key-label { color: #666; }
        .black-key .key-label { color: white; bottom: 3px;}
        .chord-info {
            text-align: center; padding: 10px; background: #f5f5f5;
            border-radius: 8px; margin-top: 15px;
        }
        .chord-name { font-size: 20px; font-weight: bold; color: #667eea; margin-bottom: 5px;}
        .chord-notes { font-size: 14px; color: #666;}
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            color: #999;
            font-size: 12px;
        }
        @media (max-width: 480px) {
            h1 { font-size: 20px; }
            .white-key { width: 24px; height: 150px;}
            .black-key { width: 16px; height: 90px;}
            .key-label { font-size: 8px;}
            .piano { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¹ Há»£p Ã‚m Piano</h1>
        <div class="audio-activate-wrapper">
            <button id="audioActivateBtn">ðŸ”Š Báº­t tiáº¿ng</button>
        </div>
        <div class="chord-selector">
            <div class="selector-row">
                <select id="rootNote">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
                <select id="chordType">
                    <option value="major">Major (TrÆ°á»Ÿng)</option>
                    <option value="minor">Minor (Thá»©)</option>
                    <option value="7">7 (Dominant 7th)</option>
                    <option value="maj7">maj7 (Major 7th)</option>
                    <option value="m7">m7 (Minor 7th)</option>
                    <option value="dim">dim (Giáº£m)</option>
                    <option value="aug">aug (TÄƒng)</option>
                    <option value="sus2">sus2</option>
                    <option value="sus4">sus4</option>
                    <option value="6">6 (Major 6th)</option>
                    <option value="m6">m6 (Minor 6th)</option>
                </select>
            </div>
        </div>
        <div class="play-buttons">
            <button class="play-sequential" id="btnSequential">â–¶ Cháº¡y Láº§n LÆ°á»£t</button>
            <button class="play-together" id="btnTogether">â–¶ Cháº¡y CÃ¹ng LÃºc</button>
        </div>
        <div class="piano">
            <div class="piano-keys" id="pianoKeys"></div>
        </div>
        <div class="chord-info">
            <div class="chord-name" id="chordName">C Major</div>
            <div class="chord-notes" id="chordNotes">C4 - E4 - G4</div>
        </div>
        <div class="footer">
            Created by Minh Nhá»±t Â© 2025
        </div>
    </div>

    <script>
        const AUDIO_BASE_URL = 'https://raw.githubusercontent.com/Nhut11790/nhut11790.github.io/main/tieng/acoustic_grand_piano-mp3/';
        const noteToFileName = {
            'C': 'C', 'C#': 'Db', 'D': 'D', 'D#': 'Eb', 'E': 'E', 'F': 'F',
            'F#': 'Gb', 'G': 'G', 'G#': 'Ab', 'A': 'A', 'A#': 'Bb', 'B': 'B'
        };
        const chordFormulas = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            '7': [0, 4, 7, 10],
            'maj7': [0, 4, 7, 11],
            'm7': [0, 3, 7, 10],
            'dim': [0, 3, 6],
            'aug': [0, 4, 8],
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9]
        };
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        let currentChordNotes = [];
        let isPlaying = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBufferCache = {};
        let isAudioActivated = false;

        const audioActivateBtn = document.getElementById('audioActivateBtn');
        audioActivateBtn.addEventListener('click', async function() {
            audioActivateBtn.disabled = true;
            audioActivateBtn.textContent = "Äang báº­t tiáº¿ng...";
            try {
                await activateAudioOnIOS();
                audioActivateBtn.textContent = "Ã‚m thanh Ä‘Ã£ báº­t!";
                isAudioActivated = true;
            } catch (e) {
                audioActivateBtn.disabled = false;
                audioActivateBtn.textContent = "ðŸ”Š Báº­t tiáº¿ng (lá»—i, thá»­ láº¡i)";
                alert("CÃ³ lá»—i khi báº­t tiáº¿ng, hÃ£y thá»­ láº¡i.");
            }
        });

        async function activateAudioOnIOS() {
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            let url = 'https://raw.githubusercontent.com/nhut990/files/refs/heads/main/tieng/E3_active_audio.mp3';
            let response = await fetch(url);
            let buffer = await response.arrayBuffer();
            let audioBuffer = await audioCtx.decodeAudioData(buffer);
            let source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);
            source.start(0);
            await new Promise(resolve => setTimeout(resolve, 330));
        }

        async function loadAudioBuffer(noteName) {
            if (audioBufferCache[noteName]) return audioBufferCache[noteName];
            const note = noteName.slice(0, -1);
            const octave = noteName.slice(-1);
            const fileName = noteToFileName[note];
            const audioUrl = `${AUDIO_BASE_URL}${fileName}${octave}.mp3`;
            try {
                const response = await fetch(audioUrl);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                audioBufferCache[noteName] = audioBuffer;
                return audioBuffer;
            } catch (error) {
                console.error('Lá»—i táº£i Ã¢m thanh:', noteName, error);
                return null;
            }
        }

        async function preloadAllNotesBuffer() {
            const noteList = [];
            for (let octave = 3; octave <= 5; octave++) {
                const endIndex = (octave === 5) ? 0 : 11;
                for (let i = 0; i <= endIndex; i++) {
                    noteList.push(notes[i] + octave);
                }
            }
            await Promise.all(noteList.map(note => loadAudioBuffer(note)));
        }

        async function playNote(noteName, duration = 300, fromSequential = false) {
            try {
                if (audioCtx.state === 'suspended' || !isAudioActivated) {
                    audioActivateBtn.disabled = false;
                    audioActivateBtn.textContent = "ðŸ”Š Báº­t tiáº¿ng Ä‘á»ƒ nghe há»£p Ã¢m!";
                    alert("Vui lÃ²ng báº¥m nÃºt Báº­t tiáº¿ng phÃ­a trÃªn Ä‘á»ƒ nghe Ä‘Æ°á»£c Ã¢m thanh há»£p Ã¢m!");
                    return;
                }
                const audioBuffer = await loadAudioBuffer(noteName);
                if (!audioBuffer) return;
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioCtx.destination);
                source.start(0);
                if (fromSequential) highlightKey(noteName, 'playing');
                if (fromSequential) {
                    setTimeout(() => { highlightKey(noteName, 'highlight'); }, duration);
                }
            } catch (error) {
                console.error('Lá»—i phÃ¡t Ã¢m thanh:', error);
            }
        }

        function highlightKey(noteName, className) {
            const key = document.querySelector(`[data-note="${noteName}"]`);
            if (key) {
                key.classList.remove('playing', 'highlight');
                if (className) key.classList.add(className);
            }
        }

        function getChordNotes(root, chordType) {
            const rootIndex = notes.indexOf(root);
            const formula = chordFormulas[chordType];
            const chordNotes = [];
            let startOctave = 3;

            formula.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const octaveOffset = Math.floor((rootIndex + interval) / 12);
                const octave = startOctave + octaveOffset;
                if (octave >= 3 && octave <= 5) {
                    chordNotes.push(notes[noteIndex] + octave);
                }
            });
            return chordNotes;
        }

        function createPiano() {
            const pianoKeys = document.getElementById('pianoKeys');
            pianoKeys.innerHTML = '';

            const isMobile = window.innerWidth <= 480;
            const whiteKeyWidth = isMobile ? 24 : 28;
            let whiteKeyIndex = 0;

            for (let octave = 3; octave <= 5; octave++) {
                const startIndex = (octave === 3) ? 0 : 0;
                const endIndex = (octave === 5) ? 0 : 11;

                for (let i = startIndex; i <= endIndex; i++) {
                    const note = notes[i];
                    const noteName = note + octave;
                    const isBlack = note.includes('#');

                    if (!isBlack) {
                        const whiteKeyContainer = document.createElement('div');
                        whiteKeyContainer.style.position = 'relative';
                        whiteKeyContainer.style.display = 'inline-flex';
                        whiteKeyContainer.style.width = whiteKeyWidth + 'px';

                        const whiteKey = document.createElement('div');
                        whiteKey.className = 'key white-key';
                        whiteKey.dataset.note = noteName;
                        const label = document.createElement('div');
                        label.className = 'key-label';
                        label.textContent = note.replace('#', 'â™¯') + octave;
                        whiteKey.appendChild(label);

                        whiteKey.addEventListener('mousedown', async () => {
                            whiteKey.classList.remove('highlight');
                            whiteKey.classList.add('playing');
                            await playNote(noteName);
                        });
                        whiteKey.addEventListener('mouseup', () => {
                            whiteKey.classList.remove('playing');
                            if (currentChordNotes.includes(noteName)) {
                                whiteKey.classList.add('highlight');
                            }
                        });
                        whiteKey.addEventListener('mouseleave', () => {
                            whiteKey.classList.remove('playing');
                            if (currentChordNotes.includes(noteName)) {
                                whiteKey.classList.add('highlight');
                            }
                        });
                        whiteKey.addEventListener('touchstart', async (e) => {
                            e.preventDefault();
                            whiteKey.classList.remove('highlight');
                            whiteKey.classList.add('playing');
                            await playNote(noteName);
                        });
                        whiteKey.addEventListener('touchend', () => {
                            whiteKey.classList.remove('playing');
                            if (currentChordNotes.includes(noteName)) {
                                whiteKey.classList.add('highlight');
                            }
                        });
                        whiteKeyContainer.appendChild(whiteKey);

                        if (i < 11 && notes[i+1].includes('#') && note !== 'E' && note !== 'B') {
                            const blackKey = document.createElement('div');
                            blackKey.className = 'key black-key';
                            const blackNoteName = notes[i+1] + octave;
                            blackKey.dataset.note = blackNoteName;
                            blackKey.style.left = (whiteKeyWidth * 0.65) + 'px';

                            const blackLabel = document.createElement('div');
                            blackLabel.className = 'key-label';
                            blackLabel.textContent = notes[i+1].replace('#', 'â™¯') + octave;
                            blackKey.appendChild(blackLabel);

                            blackKey.addEventListener('mousedown', async (e) => {
                                e.stopPropagation();
                                blackKey.classList.remove('highlight');
                                blackKey.classList.add('playing');
                                await playNote(blackNoteName);
                            });
                            blackKey.addEventListener('mouseup', (e) => {
                                e.stopPropagation();
                                blackKey.classList.remove('playing');
                                if (currentChordNotes.includes(blackNoteName)) {
                                    blackKey.classList.add('highlight');
                                }
                            });
                            blackKey.addEventListener('mouseleave', () => {
                                blackKey.classList.remove('playing');
                                if (currentChordNotes.includes(blackNoteName)) {
                                    blackKey.classList.add('highlight');
                                }
                            });
                            blackKey.addEventListener('touchstart', async (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                blackKey.classList.remove('highlight');
                                blackKey.classList.add('playing');
                                await playNote(blackNoteName);
                            });
                            blackKey.addEventListener('touchend', (e) => {
                                e.stopPropagation();
                                blackKey.classList.remove('playing');
                                if (currentChordNotes.includes(blackNoteName)) {
                                    blackKey.classList.add('highlight');
                                }
                            });
                            whiteKeyContainer.appendChild(blackKey);
                        }

                        pianoKeys.appendChild(whiteKeyContainer);
                        whiteKeyIndex++;
                    }
                }
            }
        }

        function scrollChordIntoView() {
            if (!currentChordNotes.length) return;

            setTimeout(() => {
                const pianoContainer = document.querySelector('.piano');

                const noteElements = currentChordNotes
                    .map(note => document.querySelector(`[data-note="${note}"]`))
                    .filter(el => el !== null);

                if (noteElements.length) {
                    const positions = noteElements.map(el => {
                        const rect = el.getBoundingClientRect();
                        return pianoContainer.scrollLeft + rect.left - pianoContainer.getBoundingClientRect().left;
                    });

                    const leftEdge = Math.min(...positions);
                    const rightEdge = Math.max(...positions) + noteElements[0].offsetWidth;
                    const center = (leftEdge + rightEdge) / 2;
                    const containerWidth = pianoContainer.offsetWidth;

                    const scrollLeft = center - containerWidth / 2;

                    if (pianoContainer.scrollTo) {
                        pianoContainer.scrollTo({
                            left: scrollLeft,
                            behavior: 'smooth'
                        });
                    } else {
                        pianoContainer.scrollLeft = scrollLeft;
                    }
                }
            }, 50);
        }

        function clearAllHighlight() {
            // âœ… FIX: XÃ³a Háº¾T táº¥t cáº£ highlight, playing, vÃ  inline style tá»« Táº¤T Cáº¢ phÃ­m
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('highlight', 'playing');
                // Force remove any lingering styles
                if (key.classList.length === 1) { // Chá»‰ cÃ²n class 'key'
                    key.style.background = '';
                    key.style.boxShadow = '';
                }
            });
        }

        function updateChordDisplay() {
            const root = document.getElementById('rootNote').value;
            const chordType = document.getElementById('chordType').value;
            const newChordNotes = getChordNotes(root, chordType);

            // âœ… FIX: XÃ³a sáº¡ch táº¥t cáº£ trÆ°á»›c
            clearAllHighlight();

            // âœ… FIX: ThÃªm highlight cho cÃ¡c ná»‘t má»›i
            newChordNotes.forEach(note => {
                const key = document.querySelector(`[data-note="${note}"]`);
                if (key) {
                    key.classList.add('highlight');
                }
            });

            // âœ… FIX: Cáº­p nháº­t currentChordNotes
            currentChordNotes = newChordNotes;

            const chordNames = {
                'major': '',
                'minor': 'm',
                '7': '7',
                'maj7': 'maj7',
                'm7': 'm7',
                'dim': 'dim',
                'aug': 'aug',
                'sus2': 'sus2',
                'sus4': 'sus4',
                '6': '6',
                'm6': 'm6'
            };

            document.getElementById('chordName').textContent = root + chordNames[chordType];
            document.getElementById('chordNotes').textContent = currentChordNotes.map(n => n.replace('#', 'â™¯')).join(' - ');
            scrollChordIntoView();
        }

        async function playSequential() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('btnSequential').disabled = true;
            document.getElementById('btnTogether').disabled = true;

            for (let i = 0; i < currentChordNotes.length; i++) {
                await playNote(currentChordNotes[i], 440, true);
                await new Promise(resolve => setTimeout(resolve, 450));
            }

            isPlaying = false;
            document.getElementById('btnSequential').disabled = false;
            document.getElementById('btnTogether').disabled = false;
        }

        async function playTogether() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('btnSequential').disabled = true;
            document.getElementById('btnTogether').disabled = true;

            currentChordNotes.forEach(note => highlightKey(note, 'playing'));
            await Promise.all(currentChordNotes.map(note => playNote(note, 800)));

            setTimeout(() => {
                clearAllHighlight();
                // âœ… FIX: Re-highlight há»£p Ã¢m hiá»‡n táº¡i
                currentChordNotes.forEach(note => {
                    const key = document.querySelector(`[data-note="${note}"]`);
                    if (key) key.classList.add('highlight');
                });
                isPlaying = false;
                document.getElementById('btnSequential').disabled = false;
                document.getElementById('btnTogether').disabled = false;
            }, 800);
        }

        document.getElementById('rootNote').addEventListener('change', updateChordDisplay);
        document.getElementById('chordType').addEventListener('change', updateChordDisplay);
        document.getElementById('btnSequential').addEventListener('click', playSequential);
        document.getElementById('btnTogether').addEventListener('click', playTogether);

        function handleResize() {
            createPiano();
            updateChordDisplay();
        }

        window.addEventListener('resize', handleResize);

        createPiano();
        updateChordDisplay();
        preloadAllNotesBuffer();
    </script>
</body>
</html>