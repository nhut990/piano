<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>üéπ ƒê√†n Piano 72 ph√≠m (C2-B7)</title>
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); margin:0; padding:0; min-height:100vh;}
    .container { width:100%; max-width:1600px; margin:auto; position:relative; padding:28px 0 14px;}
    h1 { color: #FFD700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 0 0 10px 0;}

    .control-bar {
      text-align: center; margin-bottom: 9px;
      display: flex; justify-content: center; gap:14px; align-items:center; flex-wrap: wrap;
    }
    .size-label { color: #fff; font-weight: bold; font-size: 15px; margin-right:3px;}
    .size-slider { width: 120px; height: 24px; }
    .fullscreen-btn {
      background: linear-gradient(137deg,#2ac7ec,#2caf97); color: #fff; border: none; border-radius: 8px; padding: 4px 13px;
      font-size: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.11); transition: all 0.13s;
    }
    .fullscreen-btn:active { transform: scale(0.97);}
    .fullscreen-btn.active { background: linear-gradient(137deg,#43a047,#2ac7ec); color:#FFD700;}

    .sound-control { position: absolute; top: 10px; right: 14px; display: flex; flex-direction: column; align-items: center; z-index: 100; }
    .sound-toggle { background: linear-gradient(145deg, #2ac7ec, #1594bb); color: white; border: none;
      border-radius: 50%; width: 36px; height: 36px; font-size: 19px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.22);
      transition: all 0.2s; display: flex; align-items: center; justify-content: center;}
    .sound-toggle.muted { background: linear-gradient(145deg, #f44336, #d32f2f);}
    .sound-toggle:active { transform: scale(0.96); }
    .sound-status { color: white; font-size: 12px; font-weight: bold; margin-top: 2px; text-shadow: 0 1px 3px rgba(0,0,0,0.14); }
    .loading-status { text-align: center; color: #FFD700; font-size: 13px; margin: 7px 0 10px 0; font-weight: bold; pointer-events: none; }
    #alert { text-align: center; color: #f44336; background: #fff2f2; border-radius: 7px; font-size: 14px; font-weight:bold;
      margin: 11px auto 0 auto; max-width: 320px; padding: 8px 11px; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid #ffd9d9;
    }
    .scroll-tip {
      text-align: center;
      color: #FFD700;
      font-size: 15px;
      margin: 2px auto 10px auto;
      font-weight: bold;
      text-shadow: 0 2px 10px rgba(20,20,20,0.2);
      display: block;
    }
    @media (min-width: 800px) {
      .scroll-tip { display: none; }
    }
    .piano-container {
      background: rgba(0,0,0,0.27); backdrop-filter: blur(8px);
      border-radius: 10px; padding: 10px; box-shadow: 0 9px 28px rgba(0,0,0,0.39);
      max-width: 1540px; margin: auto;
      overflow-x: auto;
      transition: all 0.2s;
      cursor: grab;
      scrollbar-width: thin;
      scrollbar-color: #FFD700 #2ac7ec;
      overscroll-behavior-x: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x;
    }
    .piano-container::-webkit-scrollbar {
      height: 9px;
      background: #2ac7ec;
      border-radius: 6px;
    }
    .piano-container::-webkit-scrollbar-thumb {
      background: #FFD700;
      border-radius: 5px;
    }
    .piano {
      position: relative; height: 180px; min-width: 2376px; margin: 0 auto;
      user-select: none;
      transition: all 0.25s;
      -webkit-user-select: none;
      touch-action: none;
    }
    .white-key { position: absolute; background: linear-gradient(to bottom, #fff 0%, #ececec 100%);
      border: 2px solid #222; border-radius: 0 0 6px 6px; cursor: pointer; user-select: none; display: flex;
      align-items: flex-end; justify-content: center; font-size: 9px; color: #555; font-weight: bold; transition: all 0.06s;}
    .white-key.active { background: linear-gradient(137deg, #2ac7ec 0%, #76e2ff 100%); color: #1d8a95;}
    .white-key:active { background: linear-gradient(137deg, #b3e5fc 0%, #2ac7ec 100%);}
    .black-key { position: absolute; background: linear-gradient(to bottom, #444 0%, #091a21 100%);
      border: 1px solid #111; border-radius: 0 0 4px 4px; cursor: pointer; user-select: none; z-index: 9; color: white;
      display: flex; align-items: flex-end; justify-content: center; font-size: 7px; font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.52); transition: all 0.05s;}
    .black-key.active { background: linear-gradient(137deg, #2ac7ec 0%, #76e2ff 100%); color: #1d8a95;}
    .black-key:active { background: linear-gradient(137deg, #b3e5fc 0%, #2ac7ec 100%);}
    .created-by-footer { text-align: center; color: #fff; font-size: 15px; opacity: 0.91; margin: 29px auto 12px auto; width: 100%; }

    body.landscape .piano-container {
      max-width: 100vw;
      height: 220px;
      min-height: 120px;
    }
    body.landscape .piano {
      width: 99vw !important; min-width: 0; max-width: none;
      height: 180px;
    }
    body.landscape {
      min-height: 100vw;
      background: linear-gradient(90deg,#667eea 0%,#764ba2 100%);
    }
    @media (max-width: 2400px){ .piano { width:2392px; max-width:98vw;} }
    @media (max-width: 1900px){ .piano { width:1910px;} }
    @media (max-width: 1290px){ .piano { width:1260px;} }
    @media (max-width: 900px){
      .piano-container{max-width:99vw;}
      .piano{width:930px;}
      .black-key, .white-key { font-size: 11px !important; }
    }
    @media (max-width: 700px){
      .piano{width:650px;}
      .piano-container{padding:3px;}
      .black-key, .white-key { font-size: 13px !important; }
    }
    @media (max-width: 650px){
      .piano{width:99vw;}
      .container{padding:6px 0;}
      .piano-container{padding:1px;}
    }
    @media (max-width: 500px) {
      .black-key, .white-key { font-size: 15px !important;}
      .piano{height:110px !important;}
      .container{padding:2px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sound-control">
      <button class="sound-toggle muted" id="soundToggle">
        <span id="soundIcon">üîá</span>
      </button>
      <span class="sound-status" id="soundStatus">T·∫Øt √¢m</span>
    </div>
    <h1>üéπ ƒê√†n Piano 72 ph√≠m (C2-B7)</h1>
    <div class="control-bar">
      <span class="size-label">K√≠ch th∆∞·ªõc ph√≠m:</span>
      <input type="range" min="18" max="54" value="33" step="1" class="size-slider" id="keySizeSlider">
      <button class="fullscreen-btn" id="fullscreenBtn">Ch·∫ø ƒë·ªô ngang</button>
    </div>
    <div class="loading-status" id="loadingStatus">‚è≥ ƒêang t·∫£i Piano...</div>
    <div id="alert"></div>
    <div class="piano-container" id="pianoContainer">
      <div class="piano" id="piano"></div>
    </div>
  </div>
  <div class="scroll-tip">üëâ N·∫øu kh√¥ng th·∫•y h·∫øt b√†n ph√≠m, h√£y gi·ªØ v√† k√©o sang ngang ƒë·ªÉ ch∆°i c√°c ph√≠m kh√°c.</div>
  <div class="created-by-footer">Created by Minh Nh·ª±t</div>
  <script>
    const WHITE_NOTES = [
      "C2","D2","E2","F2","G2","A2","B2",
      "C3","D3","E3","F3","G3","A3","B3",
      "C4","D4","E4","F4","G4","A4","B4",
      "C5","D5","E5","F5","G5","A5","B5",
      "C6","D6","E6","F6","G6","A6","B6",
      "C7","D7","E7","F7","G7","A7","B7"
    ];
    const BLACK_NOTES_LAYOUT = [
      {note:"C#2",pos:"C2"}, {note:"D#2",pos:"D2"},
      {note:"F#2",pos:"F2"}, {note:"G#2",pos:"G2"}, {note:"A#2",pos:"A2"},
      {note:"C#3",pos:"C3"}, {note:"D#3",pos:"D3"},
      {note:"F#3",pos:"F3"}, {note:"G#3",pos:"G3"}, {note:"A#3",pos:"A3"},
      {note:"C#4",pos:"C4"}, {note:"D#4",pos:"D4"},
      {note:"F#4",pos:"F4"}, {note:"G#4",pos:"G4"}, {note:"A#4",pos:"A4"},
      {note:"C#5",pos:"C5"}, {note:"D#5",pos:"D5"},
      {note:"F#5",pos:"F5"}, {note:"G#5",pos:"G5"}, {note:"A#5",pos:"A5"},
      {note:"C#6",pos:"C6"}, {note:"D#6",pos:"D6"},
      {note:"F#6",pos:"F6"}, {note:"G#6",pos:"G6"}, {note:"A#6",pos:"A6"},
      {note:"C#7",pos:"C7"}, {note:"D#7",pos:"D7"},
      {note:"F#7",pos:"F7"}, {note:"G#7",pos:"G7"}, {note:"A#7",pos:"A7"},
    ];
    let whiteKeyWidth = 33, blackKeyWidth = 22, whiteKeyHeight = 180, blackKeyHeight = 110;
    function getWhiteKeyPosX() {
      let obj = {};
      WHITE_NOTES.forEach((note,i)=>{obj[note]=i*whiteKeyWidth;});
      return obj;
    }
    const pianoNotesAll = WHITE_NOTES.concat(BLACK_NOTES_LAYOUT.map(n=>n.note)).sort((a,b) => {
      function noteMidi(note) {
        const ORDER = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};
        let m = note.match(/^([A-G]#?)(\d)$/);
        return 12*(parseInt(m[2])+1) + ORDER[m[1]];
      }
      return noteMidi(a)-noteMidi(b);
    });
    const notesFreq = {};
    pianoNotesAll.forEach(function(note){
      const ORDER = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};
      let m = note.match(/^([A-G]#?)(\d)$/);
      let midi = 12*(parseInt(m[2])+1)+ORDER[m[1]];
      notesFreq[note]=440 * Math.pow(2, (midi-69)/12);
    });
    const sampleInstrument = { name: 'üéπ Acoustic Grand Piano', folder: 'acoustic_grand_piano-mp3' };
    const sampleBaseURL = "https://raw.githubusercontent.com/Nhut11790/nhut11790.github.io/main/tieng/";
    let audioContext = null;
    let isMuted = true, isAudioActivated = false;
    let sampleBuffers = {};
    let hasPreload = false;
    function initAudioContext() {
      if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
      if (audioContext.state === 'suspended') audioContext.resume();
    }
    function convertSharpToFlat(note) {
      const sharpToFlat = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
      for (let sharp in sharpToFlat) {
        if (note.startsWith(sharp)) return note.replace(sharp, sharpToFlat[sharp]);
      }
      return note;
    }
    async function preloadSamples() {
      let notesList = pianoNotesAll;
      let folder = sampleInstrument.folder;
      let successCount = 0;
      document.getElementById('loadingStatus').textContent = `‚è≥ ƒêang t·∫£i Piano...`;
      let promises = notesList.map(note => {
        let flatNote = convertSharpToFlat(note);
        let fileName = flatNote + '.mp3';
        let url = `${sampleBaseURL}${folder}/${fileName}`;
        return fetch(url)
          .then(res => res.ok ? res.arrayBuffer() : null)
          .then(buf => buf ? audioContext.decodeAudioData(buf) : null)
          .then(audioBuf => { 
            if(audioBuf) { sampleBuffers[note] = audioBuf; successCount++;
              document.getElementById('loadingStatus').textContent = `‚è≥ ƒêang t·∫£i Piano... (${successCount}/${notesList.length})`;
            }
          }).catch(()=>{});
      });
      await Promise.all(promises);
      if (successCount === 0) {
        document.getElementById('loadingStatus').textContent = `‚ùå Kh√¥ng th·ªÉ t·∫£i piano`;
      } else {
        document.getElementById('loadingStatus').textContent = `‚úÖ ƒê√£ t·∫£i Piano`;
        setTimeout(() => { document.getElementById('loadingStatus').style.display = 'none'; },1300);
      }
      hasPreload = true;
    }
    async function ensureSamples() {
      initAudioContext();
      if (!hasPreload) {
        document.getElementById('loadingStatus').style.display = 'block';
        await preloadSamples();
      }
    }
    function showAlert(msg) {
      const alertBox = document.getElementById("alert");
      alertBox.textContent = msg;
      alertBox.style.display = "block";
      setTimeout(() => { alertBox.style.display = "none"; }, 2100);
    }
    function renderPiano() {
      const whiteKeyPosX = getWhiteKeyPosX();
      const pianoDiv = document.getElementById('piano');
      pianoDiv.innerHTML = '';
      pianoDiv.style.height = whiteKeyHeight + "px";
      pianoDiv.style.width = (WHITE_NOTES.length*whiteKeyWidth) + "px";
      WHITE_NOTES.forEach((note, i) => {
        const key = document.createElement('div');
        key.className = 'white-key';
        key.dataset.note = note;
        key.textContent = note;
        key.style.left = `${whiteKeyPosX[note]}px`;
        key.id = 'key_'+note;
        key.tabIndex = 0;
        key.style.width = whiteKeyWidth+"px";
        key.style.height = whiteKeyHeight+"px";
        key.style.paddingBottom = Math.round(whiteKeyHeight/45)+"px";
        key.style.fontSize = Math.max(9,Math.round(whiteKeyWidth/3))+"px";
        key.addEventListener('mousedown', () => { key.classList.add('active'); playKeyNote(note,key); });
        key.addEventListener('touchstart', (e) => { e.preventDefault(); key.classList.add('active'); playKeyNote(note,key); });
        key.addEventListener('mouseup', () => { key.classList.remove('active'); });
        key.addEventListener('mouseleave', () => { key.classList.remove('active'); });
        key.addEventListener('touchend', () => { key.classList.remove('active'); });
        pianoDiv.appendChild(key);
      });
      BLACK_NOTES_LAYOUT.forEach(bl=>{
        const key = document.createElement('div');
        key.className = 'black-key';
        key.dataset.note = bl.note;
        key.textContent = bl.note;
        key.style.left = `${whiteKeyPosX[bl.pos]+(whiteKeyWidth - blackKeyWidth/2)}px`;
        key.id = 'key_'+bl.note;
        key.tabIndex = 0;
        key.style.width = blackKeyWidth+"px";
        key.style.height = blackKeyHeight+"px";
        key.style.paddingBottom = Math.round(blackKeyHeight/35)+"px";
        key.style.fontSize = Math.max(7,Math.round(blackKeyWidth/4))+"px";
        key.addEventListener('mousedown', () => { key.classList.add('active'); playKeyNote(bl.note,key); });
        key.addEventListener('touchstart', (e) => { e.preventDefault(); key.classList.add('active'); playKeyNote(bl.note,key); });
        key.addEventListener('mouseup', () => { key.classList.remove('active'); });
        key.addEventListener('mouseleave', () => { key.classList.remove('active'); });
        key.addEventListener('touchend', () => { key.classList.remove('active'); });
        pianoDiv.appendChild(key);
      });
    }
    async function playSample(note, volume=1.0, duration=1200) {
      if (!audioContext || isMuted || !isAudioActivated) return;
      let sampleBuffer = sampleBuffers[note];
      let rootNote = note;
      if (!sampleBuffer) {
        const availableNotes = Object.keys(sampleBuffers).filter(n => sampleBuffers[n]);
        let minDiff = Infinity, bestNote=null;
        for(const avail of availableNotes){
          let diff = Math.abs(notesFreq[avail] - notesFreq[note]);
          if(diff < minDiff){minDiff=diff;bestNote=avail;}
        }
        if (!bestNote) return;
        sampleBuffer = sampleBuffers[bestNote];
        rootNote = bestNote;
      }
      const src = audioContext.createBufferSource();
      src.buffer = sampleBuffer;
      let semitone = Math.log2(notesFreq[note] / notesFreq[rootNote]) * 12;
      src.playbackRate.value = Math.pow(2,semitone/12);
      const gainNode = audioContext.createGain();
      gainNode.gain.value = volume;
      gainNode.connect(audioContext.destination);
      src.connect(gainNode);
      src.start();
      src.stop(audioContext.currentTime + Math.min(duration/1000,src.buffer.duration/src.playbackRate.value));
    }
    async function playKeyNote(note,keyElement) {
      if (!isAudioActivated) { showAlert("B·∫≠t √¢m b·∫±ng n√∫t üîá tr∆∞·ªõc khi ch∆°i!"); return; }
      initAudioContext();
      if (keyElement) {
        keyElement.classList.add('active');
        setTimeout(() => { keyElement.classList.remove('active'); }, 200);
      }
      await ensureSamples();
      playSample(note,1.0,1110);
    }
    // √Çm thanh b·∫≠t/t·∫Øt v√† k√≠ch ho·∫°t t·ª± ƒë·ªông
    const soundToggle = document.getElementById('soundToggle');
    const soundIcon = document.getElementById('soundIcon');
    const soundStatus = document.getElementById('soundStatus');
    soundToggle.addEventListener('click', async () => {
      if (!isAudioActivated) {
        soundToggle.disabled = true;
        soundIcon.textContent = '‚è≥';
        soundStatus.textContent = 'ƒêang k√≠ch ho·∫°t...';
        try {
          initAudioContext();
          const testAudio = new Audio('https://raw.githubusercontent.com/nhut990/files/refs/heads/main/tieng/E3_active_audio.mp3');
          testAudio.volume = 0.3;
          await new Promise((resolve,reject)=>{
            testAudio.addEventListener('canplaythrough',()=>{
              testAudio.play().then(()=>{
                setTimeout(()=>{
                  testAudio.pause();
                  testAudio.currentTime=0;resolve();
                },250);
              }).catch(reject);
            },{once:true});
            testAudio.addEventListener('error',reject,{once:true});
            testAudio.load();
            setTimeout(()=>reject(new Error('Timeout')),4000);
          });
          await audioContext.resume();
          isAudioActivated = true; isMuted = false;
          soundToggle.classList.remove('muted');
          soundToggle.style.opacity = '1';
          soundToggle.style.cursor = 'pointer';
          soundIcon.textContent = 'üîä';
          soundStatus.textContent = '√Çm thanh b·∫≠t';
          soundToggle.disabled = false;
        } catch (error) {
          soundToggle.disabled = false;
          soundIcon.textContent = 'üîá';
          soundStatus.textContent = 'Th·ª≠ l·∫°i';
          alert('‚ö†Ô∏è Kh√¥ng th·ªÉ k√≠ch ho·∫°t √¢m thanh.\n\nL·ªói: ' + error.message);
        }
      } else {
        isMuted = !isMuted;
        if (isMuted) {
          soundToggle.classList.add('muted');
          soundIcon.textContent = 'üîá';
          soundStatus.textContent = 'T·∫Øt √¢m';
        } else {
          soundToggle.classList.remove('muted');
          soundIcon.textContent = 'üîä';
          soundStatus.textContent = '√Çm thanh b·∫≠t';
        }
      }
    });

    // Ch·ª©c nƒÉng ch·ªânh k√≠ch c·ª° ph√≠m
    const keySizeSlider = document.getElementById('keySizeSlider');
    keySizeSlider.addEventListener('input', function() {
      whiteKeyWidth = parseInt(this.value);
      blackKeyWidth = Math.round(this.value*0.67);
      whiteKeyHeight = 180 + (whiteKeyWidth-33)*2;
      blackKeyHeight = Math.round(whiteKeyHeight*0.61);
      renderPiano();
    });

    // Ch·ª©c nƒÉng fullscreen landscape
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    let isLandscape = false;
    function setLandscapeMode(active) {
      isLandscape = !!active;
      if(isLandscape){
        document.body.classList.add('landscape');
        fullscreenBtn.classList.add('active');
        fullscreenBtn.textContent = 'Tho√°t ngang';
        let pianoCont = document.getElementById('pianoContainer');
        pianoCont.scrollLeft = 0;
      }else{
        document.body.classList.remove('landscape');
        fullscreenBtn.classList.remove('active');
        fullscreenBtn.textContent = "Ch·∫ø ƒë·ªô ngang";
      }
    }
    fullscreenBtn.addEventListener('click',()=>{
      setLandscapeMode(!isLandscape);
    });
    window.addEventListener("orientationchange", function() {
      if(window.innerHeight < window.innerWidth) setLandscapeMode(true);
      else setLandscapeMode(false);
    });
    window.addEventListener('resize', function(){
      if(isLandscape && window.innerHeight > window.innerWidth){ setLandscapeMode(false);}
    });
    window.addEventListener('load', async () => {
      initAudioContext();
      await ensureSamples();
      renderPiano();
      document.getElementById('loadingStatus').style.display = 'none';
      if(window.innerHeight < window.innerWidth){
        setLandscapeMode(true);
      }
    });
    // K√©o vu·ªët v√πng piano-container: pan & scroll ngang d·ªÖ tr√™n mobile
    (function() {
      const pianoContainer = document.getElementById('pianoContainer');
      let isTouching = false, startX = 0, scrollStart = 0;
      pianoContainer.addEventListener('touchstart', function(e) {
        if (e.target.classList.contains('white-key') || e.target.classList.contains('black-key')) return;
        if (e.touches.length === 1) {
          isTouching = true;
          startX = e.touches[0].clientX;
          scrollStart = pianoContainer.scrollLeft;
          pianoContainer.style.cursor = 'grabbing';
        }
      });
      pianoContainer.addEventListener('touchmove', function(e){
        if (isTouching && e.touches.length === 1) {
          let dx = startX - e.touches[0].clientX;
          pianoContainer.scrollLeft = scrollStart + dx;
        }
      });
      pianoContainer.addEventListener('touchend', function(){
        isTouching = false;
        pianoContainer.style.cursor = '';
      });
      // Mouse pan
      let isPanning = false, mouseStartX = 0, mouseScrollStart = 0;
      pianoContainer.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('white-key') || e.target.classList.contains('black-key')) return;
        isPanning = true;
        mouseStartX = e.clientX;
        mouseScrollStart = pianoContainer.scrollLeft;
        pianoContainer.style.cursor = 'grabbing';
        e.preventDefault();
      });
      window.addEventListener('mousemove', function(e){
        if (isPanning) {
          let dx = mouseStartX - e.clientX;
          pianoContainer.scrollLeft = mouseScrollStart + dx;
        }
      });
      window.addEventListener('mouseup', function(){
        if (isPanning) {
          isPanning = false;
          pianoContainer.style.cursor = '';
        }
      });
      // NgƒÉn double tap zoom tr√™n mobile
      pianoContainer.addEventListener('touchend', function(e){
        if(e.cancelable && e.touches.length===0 && e.detail>1) e.preventDefault();
      });
    })();
    // T·ªëi ∆∞u mobile: NgƒÉn text ch·ªçn
    document.addEventListener('touchmove', function(e){
      if(e.target.classList.contains('white-key') || e.target.classList.contains('black-key')) e.preventDefault();
    }, { passive: false });
  </script>
</body>
</html>
